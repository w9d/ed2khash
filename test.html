
<div style="padding: 10px; border: 1px solid #ccc;">
<input type="file" id="files" name="_files[]" multiple /><br />
<button id="reset" name="reset_files" disabled="true">Reset</button>
<button id="process" name="process_files" disabled="true">Process</button>
<input id="nullendmode" type="checkbox">NULL-end-on-boundary mode</input>
</div>
<output id="list"></output>
<textarea id="ed2k_text" readonly="readonly" cols="100" rows="20"></textarea>

<script src="external/js-md4/src/md4.js"></script>
<script src="ed2k_hasher.js"></script>
<script>
  var files = [];
  var ed2k_text = document.getElementById('ed2k_text');

  function handleFileSelect(evt) {
    var _files = evt.target.files; // FileList object
    
    // files is a FileList of File objects. List some properties.
    var output = [];
    
    for (var i = 0, f; f = _files[i]; i++) {
      files.push(f);
    }
    for (var i = 0, f; f = files[i]; i++) {
      output.push('<li><strong>', escape(f.name), '</strong> (', f.type || 'n/a', ') - ',
                  f.size, ' bytes, last modified: ',
                  f.lastModified ? new Date(f.lastModified).toISOString() : 'n/a',
                  '</li>');
    }

    document.getElementById('list').innerHTML = '<ul>' + output.join('') + '</ul>';
    document.getElementById('reset').disabled = false;
    document.getElementById('process').disabled = false;
    document.getElementById('files').disabled = true;
  }

  function resetEverything(evt) {
    files = new Array();
    ed2k_text.value = '';
    document.getElementById('list').innerHTML = '';
    document.getElementById('files').value = '';
    document.getElementById('reset').disabled = true;
    document.getElementById('process').disabled = true;
    document.getElementById('files').disabled = false;
  }

  function startProcessingFiles(evt) {
    var output = [];

    if (!(files[0])) {
      console.log('process_files: no file to process, this should never happen');
      return;
    }

    var regenerate_ed2k_text = function() {
      ed2k_text.value = '';

      for (var i = 0, f; f = files[i]; i++) {
        var fsize = output[f.name].size;
        var fpercent = output[f.name].percent;
        var fed2khash = output[f.name].hash;
        ed2k_text.value += '|' + f.name + '|' + fsize + '|' +
          (fed2khash && fed2khash || '[---'+fpercent+'---]') + '|\n';
      }
    }
    var ed2k_progress = function(_file, _percent) {
      output[_file.name].percent = _percent;
      regenerate_ed2k_text();
    }
    var ed2k_file_done = function(_file, _ed2ksum) {
      output[_file.name].hash = _ed2ksum;
      regenerate_ed2k_text();
    }
    for (var i = 0, f; f = files[i]; i++) {
      output[f.name] = {'percent':0, 'size':f.size, 'hash':null};
    }

    var ed2ker = new ed2k_files(files,
      document.getElementById('nullendmode').checked,
      ed2k_progress, ed2k_file_done);
  }

  document.getElementById('files').addEventListener('change', handleFileSelect, false);
  document.getElementById('reset').addEventListener('click', resetEverything, false);
  document.getElementById('process').addEventListener('click', startProcessingFiles, false);
</script>

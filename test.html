
<div style="padding: 10px; border: 1px solid #ccc;">
<input type="file" id="files" name="_files[]" multiple /><br />
<button id="reset" name="reset_files" disabled="true">Reset</button>
<button id="process" name="process_files" disabled="true">Process</button>
</div>
<output id="list"></output>

<script>
  var files = new Array();

  var fileOffset = 0;
  var readArray = new Array();
  var readOffset = 0;
  var f = null;

  function handleFileSelect(evt) {
    var _files = evt.target.files; // FileList object
    
    // files is a FileList of File objects. List some properties.
    var output = [];
    
    for (var i = 0, f; f = _files[i]; i++) {
      files.push(f);
    }
    for (var i = 0, f; f = files[i]; i++) {
      output.push('<li><strong>', escape(f.name), '</strong> (', f.type || 'n/a', ') - ',
                  f.size, ' bytes, last modified: ',
                  f.lastModified ? new Date(f.lastModified).toISOString() : 'n/a',
                  '</li>');
    }

    document.getElementById('list').innerHTML = '<ul>' + output.join('') + '</ul>';
    document.getElementById('reset').disabled = false;
    document.getElementById('process').disabled = false;
  }
  
  function resetEverything(evt) {
    files = new Array();
    document.getElementById('list').innerHTML = '';
    document.getElementById('files').value = '';
    document.getElementById('reset').disabled = true;
  }
  
  function startProcessingFiles(evt) {
    f = files[fileOffset++];
    console.log('process_files: starting', f.name);

    setTimeout(processFiles, 100);
    whatsHappening();
  }

  function processFiles() {
    console.log('process_files: loop');
    //for (var i = 0, f; f = files[i]; i++) {
    while (readArray.length < 5 && !(readOffset > f.size)) {
      var file = new FileReader();
      
      console.log('process_files: name=',f.name,'size=',f.size,'offset=',readOffset);

      file.readAsArrayBuffer(f.slice(readOffset, readOffset + 9728000));
      readOffset = readOffset + 9728000;

      file.addEventListener('loadend', newBlock, false);
    }

    if (readOffset > f.size) {
      if (readArray.length <= 0) {
        console.log('process_files: finished', f.name);
        //f = files[fileOffset++];
        console.log('process_files: starting', f.name);
        if (!f) {
          console.log('process_files: all files processed.');
          return;
        }
      }
    }

    setTimeout(processFiles, 1000);
    //}
  }

  function newBlock(evt) {
    readArray.push(evt.target.result);
  }

  function whatsHappening() {
    console.log('queue_length=',readArray.length,'array=',readArray);
    setTimeout(whatsHappening, 10000);
  }

//   function printFileDetails(evt) {
//     var chunks = evt.total / 9728000;
//     var workers = givePowerOfTwo(navigator.hardwareConcurrency || 2);
//     var blocksize = Math.floor(Math.floor(chunks) / workers) * 9728000;
//     var single = false;
//     //var firsttwo = evt.target.result.slice(0,1);
//     //var nexttwo = evt.target.result.slice(1,2);
//     //console.log('name=',escape(f.name),'size=',f.size,'result=',file.result);
//     //console.log(evt);
//     //var firstview = new Uint8Array(firsttwo);
//     if (chunks > 1) {
//       // multiwork begin
//       if (workers > chunks) {
//         workers = Math.floor(chunks);
//         blocksize = Math.floor(Math.floor(chunks) / workers) * 9728000;
//       }
//     } else {
//       // single md4 begin
//       workers = 1;
//       blocksize = evt.total;
//       single = true;
//     }
//
//     if (!single && ((blocksize % 9728000) != 0)) {
//       // run away, something went wrong with division of work
//       console.log('something went very wrong. you should never see this.');
//       console.log('total=',evt.total,'chunks=',chunks,'workers=',workers,'blocksize=',blocksize);
//       return;
//     }
//
// console.log('total=',evt.total,'chunks=',chunks,'workers=',workers,'blocksize=',blocksize,'remainder=',(evt.total-blocksize*workers));
//     console.log(evt);
//   }

//   //
//   // givePowerOfTwo(x): When x is a power of two return x, otherwise return next
//   // lowest power of two. For example 4 returns 4 and 12 returns 8.
//   //
//   function givePowerOfTwo(x) {
//     if (!(x <= 1) && !((x != 0) && ((x & (x - 1)) == 0)))
//       return givePowerOfTwo(x - 1);
//     else if (x <= 1)
//       return 1;
//     else
//       return x;
//   }

  document.getElementById('files').addEventListener('change', handleFileSelect, false);
  document.getElementById('reset').addEventListener('click', resetEverything, false);
  document.getElementById('process').addEventListener('click', startProcessingFiles, false);
</script>


<div style="padding: 10px; border: 1px solid #ccc;">
<input type="file" id="files" multiple /><br />
<button id="reset" name="reset_files" disabled="true">Reset</button>
<button id="process" name="process_files" disabled="true">Process</button><hr />
NULL-end mode: <input id="nullendmode" type="checkbox" checked="true">
Queue length: <input id="queuelength" type="text" value="6" size="3">
Chunks per read: <input id="chunksperread" type="text" value="1" size="3">
Workers: <input id="workerstospawn" type="text" value="1" size="3">
= (<span id="sizeinfo"></span>)<hr />
<progress id="ed2k_progress_file" style="width:100%"></progress><br />
<progress id="ed2k_progress_files" style="width:100%"></progress>
</div>
<textarea id="ed2k_text" readonly="readonly" style="width:100%;resize:vertical" rows="16"></textarea>

<script src="external/js-md4/src/md4.js"></script>
<script src="ed2k_hasher.js"></script>
<script>
(function() {
  var files = [];
  const ed2k_text = document.getElementById('ed2k_text');
  const btnReset = document.getElementById('reset');
  const btnProcess = document.getElementById('process');
  const btnFileSelect = document.getElementById('files');
  const select_nullendmode = document.getElementById('nullendmode');
  const select_queuelength = document.getElementById('queuelength');
  const select_chunksperread = document.getElementById('chunksperread');
  const select_workers = document.getElementById('workerstospawn');
  const select_sizeinfo = document.getElementById('sizeinfo');
  const select_pfile = document.getElementById('ed2k_progress_file');
  const select_pfiles = document.getElementById('ed2k_progress_files');
  var terminate = null;

  function handleFileSelect(evt) {
    var _files = evt.target.files;

    for (var i = 0, f; f = _files[i]; i++) {
      files.push(f);
    }

    btnReset.disabled = false;
    btnProcess.disabled = false;
  }

  function resetEverything(evt) {
    files = [];
    ed2k_text.value = '';
    btnFileSelect.value = '';
    btnReset.disabled = true;
    btnProcess.disabled = true;
    btnFileSelect.disabled = false;
    nolongerprocess(true,true);
  }

  function startProcessingFiles(evt) {
    if (terminate) {
      nolongerprocess(true,false);
      return;
    }

    if (!(files[0])) {
      console.log('process_files: no file to process, this should never happen');
      return;
    }

    var ed2k_progress = function(_file, _current_file, _total_files) {
      select_pfile.value = _current_file;
      select_pfiles.value = _total_files;
    }
    var ed2k_file_done = function(f, _ed2ksum) {
      ed2k_text.value += '|' + f.name + '|' + f.size + '|' + _ed2ksum + '|\n';
    }

    const options = {
      nullend: select_nullendmode.checked,
      queuelength: parseInt(select_queuelength.value),
      chunksperread: parseInt(select_chunksperread.value),
      workers: parseInt(select_workers.value)
    };
    var process = ed2k_files(files, options);
    process.onprogress = ed2k_progress;
    process.onfilecomplete = ed2k_file_done;
    process.onallcomplete = (function() {nolongerprocess(false,false)});
    terminate = process.terminate;
    ed2k_text.value = '';
    btnFileSelect.disabled = true;
    btnProcess.textContent = 'Stop';
  }

  function nolongerprocess(really_do_it, progressbar) {
    if (terminate && really_do_it)
      terminate();
    terminate = null;
    btnFileSelect.disabled = false;
    btnProcess.textContent = 'Process';
    if (progressbar) {
      select_pfile.value = 0;
      select_pfiles.value = 0;
    }
  }

  function displaySituation() {
    var read_mb = (parseInt(select_chunksperread.value) * 9.728).toPrecision(5);
    var queue_mb = (parseInt(select_queuelength.value) * 9.728).toPrecision(5);
    select_sizeinfo.textContent = read_mb + 'MB reads ' + queue_mb + 'MB queue';
  }

  displaySituation();
  select_chunksperread.oninput = displaySituation;
  select_queuelength.oninput = displaySituation;

  btnFileSelect.addEventListener('change', handleFileSelect, false);
  btnReset.addEventListener('click', resetEverything, false);
  btnProcess.addEventListener('click', startProcessingFiles, false);
})();
</script>

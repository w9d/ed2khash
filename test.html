
<div style="padding: 10px; border: 1px solid #ccc;">
<input type="file" id="files" name="_files[]" multiple /><br />
<button id="reset" name="reset_files" disabled="true">Reset</button>
<button id="process" name="process_files" disabled="true">Process</button><hr />
NULL-end mode: <input id="nullendmode" type="checkbox" checked="true">
</div>
<output id="list"></output>
<textarea id="ed2k_text" readonly="readonly" cols="100" rows="20"></textarea>

<script src="external/js-md4/src/md4.js"></script>
<script src="ed2k_hasher.js"></script>
<script>
(function() {
  var files = [];
  const ed2k_text = document.getElementById('ed2k_text');
  const btnReset = document.getElementById('reset');
  const btnProcess = document.getElementById('process');
  const btnFileSelect = document.getElementById('files');
  const fileSelectList = document.getElementById('list');
  const select_nullendmode = document.getElementById('nullendmode');
  const select_queuelength = document.getElementById('queuelength');
  const select_chunksperread = document.getElementById('chunksperread');
  const select_readatlength = document.getElementById('readatlength');
  const select_workers = document.getElementById('workerstospawn');

  function handleFileSelect(evt) {
    var _files = evt.target.files; // FileList object
    
    // files is a FileList of File objects. List some properties.
    var output = [];
    
    for (var i = 0, f; f = _files[i]; i++) {
      files.push(f);
    }
    for (var i = 0, f; f = files[i]; i++) {
      output.push('<li><strong>', escape(f.name), '</strong> (', f.type || 'n/a', ') - ',
                  f.size, ' bytes, last modified: ',
                  f.lastModified ? new Date(f.lastModified).toISOString() : 'n/a',
                  '</li>');
    }

    fileSelectList.innerHTML = '<ul>' + output.join('') + '</ul>';
    btnReset.disabled = false;
    btnProcess.disabled = false;
    btnFileSelect.disabled = true;
  }

  function resetEverything(evt) {
    files = new Array();
    ed2k_text.value = '';
    fileSelectList.innerHTML = '';
    btnFileSelect.value = '';
    btnReset.disabled = true;
    btnProcess.disabled = true;
    btnFileSelect.disabled = false;
  }

  function startProcessingFiles(evt) {
    var output = [];

    if (!(files[0])) {
      console.log('process_files: no file to process, this should never happen');
      return;
    }

    var regenerate_ed2k_text = function() {
      ed2k_text.value = '';

      for (var i = 0, f; f = files[i]; i++) {
        var fsize = output[f.name].size;
        var fpercent = output[f.name].percent;
        var fed2khash = output[f.name].hash;
        ed2k_text.value += '|' + f.name + '|' + fsize + '|' +
          (fed2khash && fed2khash || '[---'+fpercent+'---]') + '|\n';
      }
    }
    var ed2k_progress = function(_file, _percent) {
      output[_file.name].percent = _percent;
      regenerate_ed2k_text();
    }
    var ed2k_file_done = function(_file, _ed2ksum) {
      output[_file.name].hash = _ed2ksum;
      regenerate_ed2k_text();
    }
    for (var i = 0, f; f = files[i]; i++) {
      output[f.name] = {'percent':0, 'size':f.size, 'hash':null};
    }

    const options = {
      nullend: select_nullendmode.checked,
    };
    ed2k_files(files, ed2k_progress, ed2k_file_done, options);
  }

  btnFileSelect.addEventListener('change', handleFileSelect, false);
  btnReset.addEventListener('click', resetEverything, false);
  btnProcess.addEventListener('click', startProcessingFiles, false);
})();
</script>
